# .github/workflows/deploy.yml

name: Deploy to Production VPS

on:
  push:
    branches: [ main ]
    paths:
      - 'services/api/**'
      - 'services/web_admin/**'
      - 'infrastructure/**'
      - 'db/**'
      - '.github/workflows/deploy.yaml'

jobs:
  smoke-test-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # This test uses docker compose to start only the API and DB services
      
      - name: Copy API files (Backend)
        run: |
          mkdir -p dist/api
          cp -r services/api/* dist/api

      - name: Copy docker files
        run: |
          mkdir -p dist/infrastructure
          cp -r infrastructure/* dist/infrastructure/

      - name: Copy database init files 
        run: |
          mkdir -p dist/db/init
          cp -r db/* dist/db/init/

      - name: Set env variables for TEST
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB_NAME: test_db
          API_PORT: 3000
          API_JWT_SECRET: test_secret
          API_JWT_EXPIRATION: 1d
          PRISMA_DATABASE_URL: "postgresql://test_user:test_password@db:5432/test_db?schema=public"
        run: |
          cd dist/infrastructure
          echo "Creating .env for testing..."
          echo "POSTGRES_USER=$POSTGRES_USER" >> .env
          echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> .env
          echo "POSTGRES_DB_NAME=$POSTGRES_DB_NAME" >> .env
          echo "API_PORT=$API_PORT" >> .env
          echo "API_JWT_SECRET=$API_JWT_SECRET" >> .env
          echo "API_JWT_EXPIRATION=$API_JWT_EXPIRATION" >> .env
          echo "PRISMA_DATABASE_URL=$PRISMA_DATABASE_URL" >> .env

      - name: Start api for smoke tests
        working-directory: dist/infrastructure
        run: |
          echo "Starting API for smoke tests..."
          docker compose -f compose-smoke.yaml -p colombo up -d api-smoke db-smoke
      
      - name: Wait for API to be ready (Healthcheck)
        run: |
          echo "Waiting for API to respond..."
          # Tries to reach the API endpoint with retries
          # (Waits up to 75 seconds, checking every 5 seconds)
          
          RETRIES=15
          until curl -s -f http://localhost:3000/v1/ping || [ $RETRIES -eq 0 ]; do
            echo "Waiting for API server... ($RETRIES retries left)"
            RETRIES=$((RETRIES-1))
            sleep 5
          done

          if [ $RETRIES -eq 0 ]; then
            echo "❌ Timeout: API server did not start in time."
            docker logs colombo-api-1
            exit 1
          fi
          
          echo "✅ API is responding!"

      - name: Check API Status (Final Verification)
        run: |
          if [ $(docker inspect -f '{{.State.Running}}' colombo-api-1) = "true" ]; then
            echo "✅ All good: API server is running and stable."
            docker logs colombo-api-1
            exit 0
          else
            echo "❌ Test Failed: The server crashed."
            docker logs colombo-api-1
            exit 1
          fi


  deploy:
    needs: smoke-test-api
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      # Build angular app
      - name: Setup Node.js (for Angular)
        uses: actions/setup-node@v5
        with:
          node-version: 24

      - name: Install dependencies (Angular)
        working-directory: services/web_admin
        run: npm ci

      - name: Build app (Angular)
        working-directory: services/web_admin
        run: npm run build -- --configuration production --base-href /amministrazione/

      - name: Move built app files (Angular)
        run: |
          mkdir -p dist/web_admin
          cp -r services/web_admin/dist/* dist/web_admin

      # Copy api files
      - name: Copy API files (Backend)
        run: |
          mkdir -p dist/api
          cp -r services/api/* dist/api

      - name: Copy docker files
        run: |
          mkdir -p dist/infrastructure
          cp -r infrastructure/* dist/infrastructure/

      - name: Copy database init files
        run: |
          mkdir -p dist/db/init
          cp -r db/* dist/db/init/

      - name: Set up SSH key
        uses: webfactory/ssh-agent@master
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set env variables
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB_NAME: ${{ secrets.POSTGRES_DB_NAME }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          API_PORT: ${{ secrets.API_PORT }}
          API_JWT_SECRET: ${{ secrets.API_JWT_SECRET }}
          API_JWT_EXPIRATION: ${{ secrets.API_JWT_EXPIRATION }}
          PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
          DUCKDNS_TOKEN: ${{ secrets.DUCKDNS_TOKEN }}

        run: |
          chmod +x ./deploy/ssh-setEnvs.sh
          ./deploy/ssh-setEnvs.sh "POSTGRES_USER" "$POSTGRES_USER" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "POSTGRES_PASSWORD" "$POSTGRES_PASSWORD" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "POSTGRES_DB_NAME" "$POSTGRES_DB_NAME" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "API_PORT" "$API_PORT" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "API_JWT_SECRET" "$API_JWT_SECRET" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "API_JWT_EXPIRATION" "$API_JWT_EXPIRATION" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "PRISMA_DATABASE_URL" "$PRISMA_DATABASE_URL" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "DUCKDNS_TOKEN" "$DUCKDNS_TOKEN" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"

      - name: Execute deployment script
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          GITHUB_ACTIONS: ${{ github.event_name }}
        run: |
          chmod +x ./deploy/ssh-deploy.sh
          ./deploy/ssh-deploy.sh "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH" "${{ github.actor }}" "${{ github.sha }}"