# .github/workflows/deploy.yml

name: Deploy to Production VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      # Build angular app
      - name: Setup Node.js (for Angular)
        uses: actions/setup-node@v5
        with:
          node-version: 24

      - name: Install dependencies (Angular)
        working-directory: services/web_admin
        run: npm ci

      - name: Build app (Angular)
        working-directory: services/web_admin
        run: npm run build -- --configuration production --base-href /amministrazione/

      - name: Move built app files (Angular)
        run: |
          mkdir -p dist/web_admin
          cp -r services/web_admin/dist/* dist/web_admin

      # Copy api files
      - name: Copy API files (Backend)
        run: |
          mkdir -p dist/api
          cp -r services/api/* dist/api

      - name: Copy docker files
        run: |
          mkdir -p dist/infrastructure
          cp -r infrastructure/* dist/infrastructure/

      - name: Copy database init files
        run: |
          mkdir -p dist/db/init
          cp -r db/* dist/db/init/

      - name: Set up SSH key
        uses: webfactory/ssh-agent@master
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set env variables
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB_NAME: ${{ secrets.POSTGRES_DB_NAME }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          API_PORT: ${{ secrets.API_PORT }}
          API_JWT_SECRET: ${{ secrets.API_JWT_SECRET }}
          API_JWT_EXPIRATION: ${{ secrets.API_JWT_EXPIRATION }}

        run: |
          chmod +x ./deploy/ssh-setEnvs.sh
          ./deploy/ssh-setEnvs.sh "POSTGRES_USER" "$POSTGRES_USER" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "POSTGRES_PASSWORD" "$POSTGRES_PASSWORD" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "POSTGRES_DB_NAME" "$POSTGRES_DB_NAME" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "API_PORT" "$API_PORT" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "API_JWT_SECRET" "$API_JWT_SECRET" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
          ./deploy/ssh-setEnvs.sh "API_JWT_EXPIRATION" "$API_JWT_EXPIRATION" "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH"
      
      - name: Execute deployment script
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          GITHUB_ACTIONS: ${{ github.event_name }}
        run: |
          chmod +x ./deploy/ssh-deploy.sh
          ./deploy/ssh-deploy.sh "$SSH_HOST" "$SSH_USER" "$DEPLOY_PATH" "${{ github.actor }}" "${{ github.sha }}"